#!/bin/bash -e

BASE=$(pwd)

test_internet_connection() {
    if ping -c 1 8.8.8.8 >/dev/null; then
        echo 'Successfully pinged Google DNS, we are connected to the internet!'
    else
        echo 'No internet connection available'
        exit 1
    fi
}

sda_has_10gb() {
    lsblk | grep sda | grep "[1-9][0-9]\+.[0-9]G" >/dev/null
}

setup_and_mount_disk() {
    parted --script /dev/sda \
        mklabel msdos \
        mkpart primary ext4 1M 100% \
        set 1 boot on
    mkfs.ext4 -F /dev/sda1
    mount /dev/sda1 /mnt
}

include_package_manager() {
    # join_by() { local IFS="$1"; shift; echo "$*"; }

    # packages=(
    # ~/tools/bin
    # /opt/bin
    # $HOME/.cargo/bin
    # /usr/local/bin
    # /usr/local/share/python
    # /usr/local/opt/go/libexec/bin
    # /usr/local/texlive/2016/bin/x86_64-darwin/
    # )

    # pacstrap -i /mnt $(join_by : "${binary_directories[@]}") --noconfirm
    pacstrap -i /mnt base base-devel --noconfirm
}

create_file_system_table() {
    genfstab -U /mnt > /mnt/etc/fstab
}

start_chrooted_setup() {
    cp $BASE/chrooted_setup /mnt/chrooted_setup
    echo 'Setting root directory to /mnt and continuing setup...'
    arch-chroot /mnt ./chrooted_setup
}

main() {
    test_internet_connection

    if sda_has_10gb; then
        echo 'Installing Arch Linux...'
        setup_and_mount_disk
        include_package_manager
        create_file_system_table
        start_chrooted_setup
        reboot
    else
        echo "couldn't find a suitable medium to install"
    fi
}

main
